{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .auth-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem 0;
    display: flex;
    align-items: center;
  }
  
  .auth-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    max-width: 800px;
    margin: 0 auto;
    background: white;
  }
  
  .auth-header {
    background: linear-gradient(135deg, #6e8efb, #a777e3);
    color: white;
    padding: 1.5rem 2rem;
    text-align: center;
  }
  
  .auth-header h2 {
    margin: 0;
    font-weight: 600;
  }
  
  .auth-form {
    padding: 2.5rem;
  }
  
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
  }
  
  .btn-primary {
    background: #667eea;
    border: none;
    padding: 0.6rem 2rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-primary:hover {
    background: #5a6fd4;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .btn-outline-secondary {
    padding: 0.6rem 2rem;
  }
  
  .password-input-group {
    position: relative;
  }
  
  .toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    z-index: 5;
  }
  
  .form-text {
    font-size: 0.8rem;
    margin-top: 0.25rem;
    color: #6c757d;
  }
  
  .password-requirements {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1.5rem;
  }
  
  .password-requirements h6 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: #495057;
  }
  
  .requirement {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: #6c757d;
  }
  
  .requirement i {
    margin-right: 0.5rem;
    font-size: 0.75rem;
  }
  
  .requirement.valid {
    color: #28a745;
  }
  
  .requirement.valid i {
    color: #28a745;
  }
  
  @media (max-width: 768px) {
    .auth-container {
      padding: 1rem;
    }
    
    .auth-form {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="auth-card">
          <!-- Header -->
          <div class="auth-header">
            <h2>Change Your Password</h2>
            <p class="mb-0">Create a strong and secure password</p>
          </div>
          
          <!-- Password Change Form -->
          <div class="auth-form">
            <form method="post" class="needs-validation" novalidate>
              {% csrf_token %}
              
              {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  {% for error in form.non_field_errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
              
              <!-- Current Password -->
              <div class="mb-4">
                <label for="{{ form.old_password.id_for_label }}" class="form-label">Current Password</label>
                <div class="input-group">
                  <input type="password" 
                         class="form-control form-control-lg" 
                         id="{{ form.old_password.id_for_label }}" 
                         name="{{ form.old_password.name }}" 
                         placeholder="Enter your current password" 
                         required>
                  <button class="toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {% if form.old_password.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.old_password.errors.0 }}
                  </div>
                {% endif %}
              </div>
              
              <!-- New Password -->
              <div class="mb-3">
                <label for="{{ form.new_password1.id_for_label }}" class="form-label">New Password</label>
                <div class="input-group">
                  <input type="password" 
                         class="form-control form-control-lg" 
                         id="{{ form.new_password1.id_for_label }}" 
                         name="{{ form.new_password1.name }}" 
                         placeholder="Create a new password" 
                         required
                         oninput="checkPasswordStrength(this.value)">
                  <button class="toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                  <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="password-strength-text" class="form-text"></div>
                {% if form.new_password1.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.new_password1.errors.0 }}
                  </div>
                {% endif %}
              </div>
              
              <!-- Password Requirements -->
              <div class="password-requirements mb-4">
                <h6>Password must contain:</h6>
                <div class="requirement" id="length-req">
                  <i class="bi bi-check-circle"></i>
                  <span>At least 8 characters</span>
                </div>
                <div class="requirement" id="uppercase-req">
                  <i class="bi bi-check-circle"></i>
                  <span>At least one uppercase letter</span>
                </div>
                <div class="requirement" id="lowercase-req">
                  <i class="bi bi-check-circle"></i>
                  <span>At least one lowercase letter</span>
                </div>
                <div class="requirement" id="number-req">
                  <i class="bi bi-check-circle"></i>
                  <span>At least one number</span>
                </div>
                <div class="requirement" id="special-req">
                  <i class="bi bi-check-circle"></i>
                  <span>At least one special character</span>
                </div>
              </div>
              
              <!-- Confirm New Password -->
              <div class="mb-4">
                <label for="{{ form.new_password2.id_for_label }}" class="form-label">Confirm New Password</label>
                <div class="input-group">
                  <input type="password" 
                         class="form-control form-control-lg" 
                         id="{{ form.new_password2.id_for_label }}" 
                         name="{{ form.new_password2.name }}" 
                         placeholder="Confirm your new password" 
                         required>
                  <button class="toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {% if form.new_password2.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.new_password2.errors.0 }}
                  </div>
                {% endif %}
              </div>
              
              <!-- Form Actions -->
              <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-2"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                  Change Password <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Toggle password visibility
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
      const passwordInput = this.previousElementSibling;
      const icon = this.querySelector('i');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      }
    });
  });
  
  // Password strength checker
  function checkPasswordStrength(password) {
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    let strength = 0;
    let messages = [];
    
    // Check password length
    const hasMinLength = password.length >= 8;
    document.getElementById('length-req').classList.toggle('valid', hasMinLength);
    if (hasMinLength) strength += 1;
    
    // Check for lowercase letters
    const hasLowercase = password.match(/[a-z]+/);
    document.getElementById('lowercase-req').classList.toggle('valid', hasLowercase);
    if (hasLowercase) strength += 1;
    
    // Check for uppercase letters
    const hasUppercase = password.match(/[A-Z]+/);
    document.getElementById('uppercase-req').classList.toggle('valid', hasUppercase);
    if (hasUppercase) strength += 1;
    
    // Check for numbers
    const hasNumber = password.match(/[0-9]+/);
    document.getElementById('number-req').classList.toggle('valid', hasNumber);
    if (hasNumber) strength += 1;
    
    // Check for special characters
    const hasSpecial = password.match(/[!@#$%^&*(),.?":{}|<>]+/);
    document.getElementById('special-req').classList.toggle('valid', hasSpecial);
    if (hasSpecial) strength += 1;
    
    // Update the strength bar
    const strengthPercent = (strength / 5) * 100;
    strengthBar.style.width = strengthPercent + '%';
    
    // Update the strength text and color
    if (password.length === 0) {
      strengthBar.className = 'progress-bar';
      strengthBar.style.width = '0%';
      strengthText.textContent = '';
    } else if (strength <= 1) {
      strengthBar.className = 'progress-bar bg-danger';
      strengthText.textContent = 'Very Weak';
      strengthText.className = 'form-text text-danger';
    } else if (strength <= 2) {
      strengthBar.className = 'progress-bar bg-warning';
      strengthText.textContent = 'Weak';
      strengthText.className = 'form-text text-warning';
    } else if (strength <= 3) {
      strengthBar.className = 'progress-bar bg-info';
      strengthText.textContent = 'Moderate';
      strengthText.className = 'form-text text-info';
    } else if (strength <= 4) {
      strengthBar.className = 'progress-bar bg-primary';
      strengthText.textContent = 'Strong';
      strengthText.className = 'form-text text-primary';
    } else {
      strengthBar.className = 'progress-bar bg-success';
      strengthText.textContent = 'Very Strong';
      strengthText.className = 'form-text text-success';
    }
  }
  
  // Form validation
  (function() {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function(form) {
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>
{% endblock %}

{% endblock %}
